{"version":3,"sources":["webpack://@flarum/core/./src/forum/components/WelcomeHero.js","webpack://@flarum/core/./src/forum/components/IndexPage.js"],"names":["WelcomeHero","oninit","vnode","this","hidden","localStorage","getItem","view","className","class","Button","icon","onclick","$","slideUp","hide","bind","app","forum","attribute","m","trust","setItem","Component","window","flreg","add","IndexPage","previous","matches","DiscussionPage","lastDiscussion","get","discussions","clear","refreshParams","search","params","history","push","translator","trans","bodyClass","scrollTopOnCreate","hero","listItems","sidebarItems","toArray","viewItems","actionItems","DiscussionList","state","setTitle","setTitleCount","oncreate","oldHeroHeight","cache","heroHeight","outerHeight","scrollTop","css","height","type","screen","$discussion","id","length","indexTop","indexBottom","discussionTop","offset","top","discussionBottom","onbeforeremove","onremove","component","items","ItemList","canStartDiscussion","session","user","itemClassName","newDiscussionAction","disabled","SelectDropdown","buttonClassName","accessibleToggleLabel","navItems","stickyParams","LinkButton","href","route","sortMap","sortOptions","i","Dropdown","label","sort","Object","keys","map","key","value","active","changeSort","title","refresh","store","find","redraw","markAllAsRead","LogInModal","DiscussionComposer","Promise","resolve","reject","composer","load","show","modal","confirm","save","markedAllAsReadAt","Date","Page"],"mappings":"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","file":"forum/components/IndexPage.js","sourcesContent":["import Component from '../../common/Component';\nimport Button from '../../common/components/Button';\n\n/**\n * The `WelcomeHero` component displays a hero that welcomes the user to the\n * forum.\n */\nexport default class WelcomeHero extends Component {\n  oninit(vnode) {\n    super.oninit(vnode);\n\n    this.hidden = localStorage.getItem('welcomeHidden');\n  }\n\n  view() {\n    if (this.hidden) return <div />;\n\n    const slideUp = () => {\n      this.$().slideUp(this.hide.bind(this));\n    };\n\n    return (\n      <header className=\"Hero WelcomeHero\">\n        <div class=\"container\">\n          {Button.component({\n            icon: 'fas fa-times',\n            onclick: slideUp,\n            className: 'Hero-close Button Button--icon Button--link',\n          })}\n\n          <div className=\"containerNarrow\">\n            <h2 className=\"Hero-title\">{app.forum.attribute('welcomeTitle')}</h2>\n            <div className=\"Hero-subtitle\">{m.trust(app.forum.attribute('welcomeMessage'))}</div>\n          </div>\n        </div>\n      </header>\n    );\n  }\n\n  /**\n   * Hide the welcome hero.\n   */\n  hide() {\n    localStorage.setItem('welcomeHidden', 'true');\n\n    this.hidden = true;\n  }\n}\n\nwindow.flreg.add('components/WelcomeHero', WelcomeHero)","import Page from '../../common/components/Page';\nimport ItemList from '../../common/utils/ItemList';\nimport listItems from '../../common/helpers/listItems';\nimport DiscussionList from './DiscussionList';\nimport WelcomeHero from './WelcomeHero';\nimport DiscussionPage from './DiscussionPage';\nimport Dropdown from '../../common/components/Dropdown';\nimport Button from '../../common/components/Button';\nimport LinkButton from '../../common/components/LinkButton';\nimport SelectDropdown from '../../common/components/SelectDropdown';\n\n/**\n * The `IndexPage` component displays the index page, including the welcome\n * hero, the sidebar, and the discussion list.\n */\nexport default class IndexPage extends Page {\n  static providesInitialSearch = true;\n\n  oninit(vnode) {\n    super.oninit(vnode);\n\n    // If the user is returning from a discussion page, then take note of which\n    // discussion they have just visited. After the view is rendered, we will\n    // scroll down so that this discussion is in view.\n    if (app.previous.matches(DiscussionPage)) {\n      this.lastDiscussion = app.previous.get('discussion');\n    }\n\n    // If the user is coming from the discussion list, then they have either\n    // just switched one of the parameters (filter, sort, search) or they\n    // probably want to refresh the results. We will clear the discussion list\n    // cache so that results are reloaded.\n    if (app.previous.matches(IndexPage)) {\n      app.discussions.clear();\n    }\n\n    app.discussions.refreshParams(app.search.params());\n\n    app.history.push('index', app.translator.trans('core.forum.header.back_to_index_tooltip'));\n\n    this.bodyClass = 'App--index';\n    this.scrollTopOnCreate = false;\n  }\n\n  view() {\n    return (\n      <div className=\"IndexPage\">\n        {this.hero()}\n        <div className=\"container\">\n          <div className=\"sideNavContainer\">\n            <nav className=\"IndexPage-nav sideNav\">\n              <ul>{listItems(this.sidebarItems().toArray())}</ul>\n            </nav>\n            <div className=\"IndexPage-results sideNavOffset\">\n              <div className=\"IndexPage-toolbar\">\n                <ul className=\"IndexPage-toolbar-view\">{listItems(this.viewItems().toArray())}</ul>\n                <ul className=\"IndexPage-toolbar-action\">{listItems(this.actionItems().toArray())}</ul>\n              </div>\n              <DiscussionList state={app.discussions} />\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  setTitle() {\n    app.setTitle(app.translator.trans('core.forum.index.meta_title_text'));\n    app.setTitleCount(0);\n  }\n\n  oncreate(vnode) {\n    super.oncreate(vnode);\n\n    this.setTitle();\n\n    // Work out the difference between the height of this hero and that of the\n    // previous hero. Maintain the same scroll position relative to the bottom\n    // of the hero so that the sidebar doesn't jump around.\n    const oldHeroHeight = app.cache.heroHeight;\n    const heroHeight = (app.cache.heroHeight = this.$('.Hero').outerHeight() || 0);\n    const scrollTop = app.cache.scrollTop;\n\n    $('#app').css('min-height', $(window).height() + heroHeight);\n\n    // Let browser handle scrolling on page reload.\n    if (app.previous.type == null) return;\n\n    // When on mobile, only retain scroll if we're coming from a discussion page.\n    // Otherwise, we've just changed the filter, so we should go to the top of the page.\n    if (app.screen() == 'desktop' || app.screen() == 'desktop-hd' || this.lastDiscussion) {\n      $(window).scrollTop(scrollTop - oldHeroHeight + heroHeight);\n    } else {\n      $(window).scrollTop(0);\n    }\n\n    // If we've just returned from a discussion page, then the constructor will\n    // have set the `lastDiscussion` property. If this is the case, we want to\n    // scroll down to that discussion so that it's in view.\n    if (this.lastDiscussion) {\n      const $discussion = this.$(`li[data-id=\"${this.lastDiscussion.id()}\"] .DiscussionListItem`);\n\n      if ($discussion.length) {\n        const indexTop = $('#header').outerHeight();\n        const indexBottom = $(window).height();\n        const discussionTop = $discussion.offset().top;\n        const discussionBottom = discussionTop + $discussion.outerHeight();\n\n        if (discussionTop < scrollTop + indexTop || discussionBottom > scrollTop + indexBottom) {\n          $(window).scrollTop(discussionTop - indexTop);\n        }\n      }\n    }\n  }\n\n  onbeforeremove() {\n    // Save the scroll position so we can restore it when we return to the\n    // discussion list.\n    app.cache.scrollTop = $(window).scrollTop();\n  }\n\n  onremove() {\n    super.onremove();\n\n    $('#app').css('min-height', '');\n  }\n\n  /**\n   * Get the component to display as the hero.\n   *\n   * @return {MithrilComponent}\n   */\n  hero() {\n    return WelcomeHero.component();\n  }\n\n  /**\n   * Build an item list for the sidebar of the index page. By default this is a\n   * \"New Discussion\" button, and then a DropdownSelect component containing a\n   * list of navigation items.\n   *\n   * @return {ItemList}\n   */\n  sidebarItems() {\n    const items = new ItemList();\n    const canStartDiscussion = app.forum.attribute('canStartDiscussion') || !app.session.user;\n\n    items.add(\n      'newDiscussion',\n      Button.component(\n        {\n          icon: 'fas fa-edit',\n          className: 'Button Button--primary IndexPage-newDiscussion',\n          itemClassName: 'App-primaryControl',\n          onclick: () => {\n            // If the user is not logged in, the promise rejects, and a login modal shows up.\n            // Since that's already handled, we dont need to show an error message in the console.\n            return this.newDiscussionAction().catch(() => {});\n          },\n          disabled: !canStartDiscussion,\n        },\n        app.translator.trans(canStartDiscussion ? 'core.forum.index.start_discussion_button' : 'core.forum.index.cannot_start_discussion_button')\n      )\n    );\n\n    items.add(\n      'nav',\n      SelectDropdown.component(\n        {\n          buttonClassName: 'Button',\n          className: 'App-titleControl',\n          accessibleToggleLabel: app.translator.trans('core.forum.index.toggle_sidenav_dropdown_accessible_label'),\n        },\n        this.navItems(this).toArray()\n      )\n    );\n\n    return items;\n  }\n\n  /**\n   * Build an item list for the navigation in the sidebar of the index page. By\n   * default this is just the 'All Discussions' link.\n   *\n   * @return {ItemList}\n   */\n  navItems() {\n    const items = new ItemList();\n    const params = app.search.stickyParams();\n\n    items.add(\n      'allDiscussions',\n      LinkButton.component(\n        {\n          href: app.route('index', params),\n          icon: 'far fa-comments',\n        },\n        app.translator.trans('core.forum.index.all_discussions_link')\n      ),\n      100\n    );\n\n    return items;\n  }\n\n  /**\n   * Build an item list for the part of the toolbar which is concerned with how\n   * the results are displayed. By default this is just a select box to change\n   * the way discussions are sorted.\n   *\n   * @return {ItemList}\n   */\n  viewItems() {\n    const items = new ItemList();\n    const sortMap = app.discussions.sortMap();\n\n    const sortOptions = {};\n    for (const i in sortMap) {\n      sortOptions[i] = app.translator.trans('core.forum.index_sort.' + i + '_button');\n    }\n\n    items.add(\n      'sort',\n      Dropdown.component(\n        {\n          buttonClassName: 'Button',\n          label: sortOptions[app.search.params().sort] || Object.keys(sortMap).map((key) => sortOptions[key])[0],\n          accessibleToggleLabel: app.translator.trans('core.forum.index_sort.toggle_dropdown_accessible_label'),\n        },\n        Object.keys(sortOptions).map((value) => {\n          const label = sortOptions[value];\n          const active = (app.search.params().sort || Object.keys(sortMap)[0]) === value;\n\n          return Button.component(\n            {\n              icon: active ? 'fas fa-check' : true,\n              onclick: app.search.changeSort.bind(app.search, value),\n              active: active,\n            },\n            label\n          );\n        })\n      )\n    );\n\n    return items;\n  }\n\n  /**\n   * Build an item list for the part of the toolbar which is about taking action\n   * on the results. By default this is just a \"mark all as read\" button.\n   *\n   * @return {ItemList}\n   */\n  actionItems() {\n    const items = new ItemList();\n\n    items.add(\n      'refresh',\n      Button.component({\n        title: app.translator.trans('core.forum.index.refresh_tooltip'),\n        icon: 'fas fa-sync',\n        className: 'Button Button--icon',\n        onclick: () => {\n          app.discussions.refresh();\n          if (app.session.user) {\n            app.store.find('users', app.session.user.id());\n            m.redraw();\n          }\n        },\n      })\n    );\n\n    if (app.session.user) {\n      items.add(\n        'markAllAsRead',\n        Button.component({\n          title: app.translator.trans('core.forum.index.mark_all_as_read_tooltip'),\n          icon: 'fas fa-check',\n          className: 'Button Button--icon',\n          onclick: this.markAllAsRead.bind(this),\n        })\n      );\n    }\n\n    return items;\n  }\n\n  /**\n   * Open the composer for a new discussion or prompt the user to login.\n   *\n   * @return {Promise}\n   */\n  newDiscussionAction() {\n    const LogInModal = () => import(/* webpackChunkName: \"forum/components/LogInModal\" */ './LogInModal');\n    const DiscussionComposer = () => import(/* webpackChunkName: \"forum/components/DiscussionComposer\" */ './DiscussionComposer');\n\n    return new Promise((resolve, reject) => {\n      if (app.session.user) {\n        app.composer.load(DiscussionComposer, { user: app.session.user });\n        app.composer.show();\n\n        return resolve(app.composer);\n      } else {\n        app.modal.show(LogInModal);\n\n        return reject();\n      }\n    });\n  }\n\n  /**\n   * Mark all discussions as read.\n   *\n   * @return void\n   */\n  markAllAsRead() {\n    const confirmation = confirm(app.translator.trans('core.forum.index.mark_all_as_read_confirmation'));\n\n    if (confirmation) {\n      app.session.user.save({ markedAllAsReadAt: new Date() });\n    }\n  }\n}\n\nwindow.flreg.add('components/IndexPage', IndexPage)"],"sourceRoot":""}