(self.webpackChunkflarum_core=self.webpackChunkflarum_core||[]).push([[563],{1565:(t,e,s)=>{"use strict";s.d(e,{Z:()=>p});var i=s(1788),o=s(1795),n=s(1749),a=s(474),r=s(431),c=s(75),l=s(7037),d=s(1698),h=s(5462),u=s(108),p=function(t){function e(){return t.apply(this,arguments)||this}(0,i.Z)(e,t);var o=e.prototype;return o.oninit=function(e){var s=this;t.prototype.oninit.call(this,e),this.revealContent=!1,this.cardVisible=!1,this.subtree.check((function(){return s.cardVisible}),(function(){return s.isEditing()}),(function(){return s.revealContent}))},o.content=function(){return t.prototype.content.call(this).concat([m("header",{className:"Post-header"},m("ul",null,(0,d.Z)(this.headerItems().toArray()))),m("div",{className:"Post-body"},this.isEditing()?m(u.Z,{className:"Post-preview",composer:app.composer}):m.trust(this.attrs.post.contentHtml()))])},o.refreshContent=function(){var t=this.isEditing()?"":this.attrs.post.contentHtml();this.contentHtml!==t&&this.$(".Post-body script").each((function(){var t=document.createElement("script");t.textContent=this.textContent,Array.from(this.attributes).forEach((function(e){return t.setAttribute(e.name,e.value)})),this.parentNode.replaceChild(t,this)})),this.contentHtml=t},o.oncreate=function(e){t.prototype.oncreate.call(this,e),this.refreshContent()},o.onupdate=function(e){t.prototype.onupdate.call(this,e),this.refreshContent()},o.isEditing=function(){var t=this;Promise.resolve().then(s.bind(s,4588)).then((function(e){return app.composer.bodyMatches(e.default,{post:t.attrs.post})}))},o.elementAttrs=function(){var e=this.attrs.post,s=t.prototype.elementAttrs.call(this);return s.className=(s.className||"")+" "+(0,n.Z)({CommentPost:!0,"Post--hidden":e.isHidden(),"Post--edited":e.isEdited(),revealContent:this.revealContent,editing:this.isEditing()}),s},o.toggleContent=function(){this.revealContent=!this.revealContent},o.headerItems=function(){var t=this,e=new l.Z,s=this.attrs.post;return e.add("user",a.Z.component({post:s,cardVisible:this.cardVisible,oncardshow:function(){t.cardVisible=!0,m.redraw()},oncardhide:function(){t.cardVisible=!1,m.redraw()}}),100),e.add("meta",r.Z.component({post:s})),s.isEdited()&&!s.isHidden()&&e.add("edited",c.Z.component({post:s})),s.isHidden()&&e.add("toggle",h.Z.component({className:"Button Button--default Button--more",icon:"fas fa-ellipsis-h",onclick:this.toggleContent.bind(this)})),e},e}(o.Z)},5915:(t,e,s)=>{"use strict";s.r(e),s.d(e,{default:()=>P});var i=s(2122),o=s(1788),n=s(6366),a=s(1252),r=s(9086),c=s(6149),l=s(3131),d=s(2956),h=s(108),u=s(1698),p=function(t){function e(){return t.apply(this,arguments)||this}(0,o.Z)(e,t);var s=e.prototype;return s.view=function(){var t=this;return app.composer.composingReplyTo(this.attrs.discussion)?m("article",{className:"Post CommentPost editing"},m("header",{className:"Post-header"},m("div",{className:"PostUser"},m("h3",null,(0,c.Z)(app.session.user,{className:"PostUser-avatar"}),(0,l.Z)(app.session.user)),m("ul",{className:"PostUser-badges badges"},(0,u.Z)(app.session.user.badges().toArray())))),m(h.Z,{className:"Post-body",composer:app.composer,surround:this.anchorPreview.bind(this)})):m("article",{className:"Post ReplyPlaceholder",onclick:function(){d.Z.replyAction.call(t.attrs.discussion,!0).catch((function(){}))}},m("header",{className:"Post-header"},(0,c.Z)(app.session.user,{className:"PostUser-avatar"})," ",app.translator.trans("core.forum.post_stream.reply_placeholder")))},s.anchorPreview=function(t){var e=$(window).scrollTop()+$(window).height()>=$(document).height();t(),e&&$(window).scrollTop($(document).height())},e}(n.Z),f=s(5462),v=s(1565),g=s(1867),b=s(8165),w=function(t){function e(){return t.apply(this,arguments)||this}(0,o.Z)(e,t);var s=e.prototype;return s.icon=function(){return"fas fa-pencil-alt"},s.description=function(t){var e=app.translator.trans("core.forum.post_stream.discussion_renamed_text",t),s=app.translator.trans("core.forum.post_stream.discussion_renamed_old_tooltip",t);return m("span",{title:(0,b.Z)(s)},e)},s.descriptionData=function(){var t=this.attrs.post,e=t.content()[0],s=t.content()[1];return{old:e,new:m("strong",{className:"DiscussionRenamedPost-new"},s)}},e}(g.Z),P=function(t){function e(){return t.apply(this,arguments)||this}(0,o.Z)(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.discussion=this.attrs.discussion,this.stream=this.attrs.stream,this.scrollListener=new a.Z(this.onscroll.bind(this))},s.postComponents=function(){return{comment:v.Z,discussionRenamed:w}},s.view=function(){var t,e=this,s=this.stream.viewingEnd(),o=this.stream.posts(),n=this.discussion.postIds(),a=function(t){$(t.dom).addClass("fadeIn"),setTimeout((function(){return $(t.dom).removeClass("fadeIn")}),500)},c=o.map((function(s,o){var c,l={"data-index":e.stream.visibleStart+o};if(s){var d=s.createdAt(),h=e.postComponents()[s.contentType()];c=h?h.component({post:s}):"",l.key="post"+s.id(),l.oncreate=a,l["data-time"]=d.toISOString(),l["data-number"]=s.number(),l["data-id"]=s.id(),l["data-type"]=s.contentType();var u=d-t;u>3456e5&&(c=[m("div",{className:"PostStream-timeGap"},m("span",null,app.translator.trans("core.forum.post_stream.time_lapsed_text",{period:dayjs().add(u,"ms").fromNow(!0)}))),c]),t=d}else l.key="post"+n[e.stream.visibleStart+o],c=r.Z.component();return m("div",(0,i.Z)({className:"PostStream-item"},l),c)}));return!s&&o[this.stream.visibleEnd-this.stream.visibleStart-1]&&c.push(m("div",{className:"PostStream-loadMore",key:"loadMore"},m(f.Z,{className:"Button",onclick:this.stream.loadNext.bind(this.stream)},app.translator.trans("core.forum.post_stream.load_more_button")))),!s||app.session.user&&!this.discussion.canReply()||c.push(m("div",{className:"PostStream-item",key:"reply","data-index":this.stream.count(),oncreate:a},p.component({discussion:this.discussion}))),m("div",{className:"PostStream"},c)},s.onupdate=function(){this.triggerScroll()},s.oncreate=function(e){var s=this;t.prototype.oncreate.call(this,e),this.triggerScroll(),setTimeout((function(){return s.scrollListener.start()}))},s.onremove=function(){this.scrollListener.stop(),clearTimeout(this.calculatePositionTimeout)},s.triggerScroll=function(){if(this.stream.needsScroll){var t=this.stream.targetPost;this.stream.needsScroll=!1,"number"in t?this.scrollToNumber(t.number,this.stream.animateScroll):"index"in t&&this.scrollToIndex(t.index,this.stream.animateScroll,t.reply)}},s.onscroll=function(t){void 0===t&&(t=window.pageYOffset),this.stream.paused||this.stream.pagesLoading||(this.updateScrubber(t),this.loadPostsIfNeeded(t),clearTimeout(this.calculatePositionTimeout),this.calculatePositionTimeout=setTimeout(this.calculatePosition.bind(this,t),100))},s.loadPostsIfNeeded=function(t){void 0===t&&(t=window.pageYOffset);var e=this.getMarginTop(),s=$(window).height()-e,i=t+e;if(this.stream.visibleStart>0){var o=this.$(".PostStream-item[data-index="+this.stream.visibleStart+"]");o.length&&o.offset().top>i-300&&this.stream.loadPrevious()}if(this.stream.visibleEnd<this.stream.count()){var n=this.$(".PostStream-item[data-index="+(this.stream.visibleEnd-1)+"]");n.length&&n.offset().top+n.outerHeight(!0)<i+s+300&&this.stream.loadNext()}},s.updateScrubber=function(t){void 0===t&&(t=window.pageYOffset);var e=this.getMarginTop(),s=$(window).height()-e,i=t+e,o=this.$(".PostStream-item[data-index]"),n=0,a="",r=null;o.each((function(){var t=$(this),e=t.offset().top,o=t.outerHeight(!0);if(e+o<i)return!0;if(e>i+s)return!1;var c=Math.max(0,i-e),l=Math.min(o,i+s-e)-c;null===r&&(r=parseFloat(t.data("index"))+c/o),l>0&&(n+=l/o);var d=t.data("time");d&&(a=d)})),this.stream.index=null!==r?r+1:this.stream.count(),this.stream.visible=n,a&&(this.stream.description=dayjs(a).format("MMMM YYYY"))},s.calculatePosition=function(t){void 0===t&&(t=window.pageYOffset);var e,s,i=this.getMarginTop(),o=$(window),n=o.height()-i,a=o.scrollTop()+i,r=t+i;this.$(".PostStream-item").each((function(){var t=$(this),i=t.offset().top,o=t.outerHeight(!0),c=Math.max(0,r-i);if(void 0===e&&(c/o<.75||(o-c)/n>.25)&&(e=t.data("number")),i+o>a){if(!(i+o<a+n))return!1;t.data("number")&&(s=t.data("number"))}})),e&&this.attrs.onPositionChange(e||1,s,e)},s.getMarginTop=function(){var t="phone"===app.screen()?"#app-navigation":"#header";return this.$()&&$(t).outerHeight()+parseInt(this.$().css("margin-top"),10)},s.scrollToNumber=function(t,e){var s=this.$(".PostStream-item[data-number="+t+"]");return this.scrollToItem(s,e).then(this.flashItem.bind(this,s))},s.scrollToIndex=function(t,e,s){var i=s?$(".PostStream-item:last-child"):this.$(".PostStream-item[data-index="+t+"]");this.scrollToItem(i,e,!0,s),s&&this.flashItem(i)},s.scrollToItem=function(t,e,s,i){var o=this,n=$("html, body").stop(!0),a=t.data("index");if(t.length){var r=t.offset().top-this.getMarginTop(),c=t.offset().top+t.height(),l=$(document).scrollTop(),d=l+$(window).height();if(s||r<l||c>d){var h=i?c-$(window).height()+app.composer.computedHeight():t.is(":first-child")?0:r;e?h!==l&&n.animate({scrollTop:h},"fast"):n.scrollTop(h)}}var u=function(){o.updateScrubber(),void 0!==a&&(o.stream.index=a+1)};return u(),this.stream.forceUpdateScrubber=!0,Promise.all([n.promise(),this.stream.loadPromise]).then((function(){var t;if(m.redraw.sync(),i){var e=$(".PostStream-item:last-child");$(window).scrollTop(e.offset().top+e.height()-$(window).height()+app.composer.computedHeight())}else 0===a?$(window).scrollTop(0):(t=$(".PostStream-item[data-index="+a+"]").offset())&&$(window).scrollTop(t.top-o.getMarginTop());u(),o.calculatePosition(),o.stream.paused=!1,o.loadPostsIfNeeded()}))},s.flashItem=function(t){t.removeClass("fadeIn"),t.addClass("flash").on("animationend webkitAnimationEnd",(function(e){t.removeClass("flash")}))},e}(n.Z)}}]);
//# sourceMappingURL=PostStream.js.map